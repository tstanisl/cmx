#include "cmx.h"
#include <stdio.h>
#include <stdlib.h>

#define INF INFINITY

#define LOG(...) fprintf(stderr, __VA_ARGS__)

#define CHECK(cnd, ...) \
    if (cnd); else (LOG(__VA_ARGS__), exit(-1))

typedef struct {
    float x;
    float y;
    uint8_t r;
} tc_s;

#define TEST(type, testcases) do {                                    \
    LOG("Testing " #type "\n");                                       \
    for (size_t i = 0; i < sizeof(testcases) / sizeof(tc_s); ++i) {   \
        tc_s t = (testcases)[i];                                      \
        type m = type ## _encode(t.x);                                \
        CHECK(m.r == t.r, "\tError: encode: %g -> %08b (got %08b)\n", \
                           t.x, t.r, m.r);                            \
        float z = type ## _decode(m);                                 \
        CHECK(z == t.y,   "\tError: decode: %g -> %g (got %g)\n",     \
                          t.x, t.y, z);                               \
    }                                                                 \
    LOG("\tPassed\n");                                                \
} while (0)

// test cases

static tc_s e2m1_tests[] =  {
    { -8.000f, -6.0f, 0b0'1'11'1 },
    { -7.000f, -6.0f, 0b0'1'11'1 },
    { -6.000f, -6.0f, 0b0'1'11'1 },
    { -4.000f, -4.0f, 0b0'1'11'0 },
    { -2.000f, -2.0f, 0b0'1'10'0 },
    { -1.000f, -1.0f, 0b0'1'01'0 },
    { -0.751f, -1.0f, 0b0'1'01'0 },
    { -0.750f, -1.0f, 0b0'1'01'0 },
    { -0.749f, -0.5f, 0b0'1'00'1 },
    { -0.500f, -0.5f, 0b0'1'00'1 },
    { -0.251f, -0.5f, 0b0'1'00'1 },
    { -0.250f, -0.5f, 0b0'1'00'1 },
    { -0.249f, -0.0f, 0b0'1'00'0 },
    { -0.000f, -0.0f, 0b0'1'00'0 },
    {  0.000f,  0.0f, 0b0'0'00'0 },
    {  0.249f,  0.0f, 0b0'0'00'0 },
    {  0.250f,  0.5f, 0b0'0'00'1 },
    {  0.251f,  0.5f, 0b0'0'00'1 },
    {  0.500f,  0.5f, 0b0'0'00'1 },
    {  0.749f,  0.5f, 0b0'0'00'1 },
    {  0.750f,  1.0f, 0b0'0'01'0 },
    {  0.751f,  1.0f, 0b0'0'01'0 },
    {  1.000f,  1.0f, 0b0'0'01'0 },
    {  1.249f,  1.0f, 0b0'0'01'0 },
    {  1.250f,  1.5f, 0b0'0'01'1 },
    {  1.251f,  1.5f, 0b0'0'01'1 },
    {  1.499f,  1.5f, 0b0'0'01'1 },
    {  1.500f,  1.5f, 0b0'0'01'1 },
    {  1.501f,  1.5f, 0b0'0'01'1 },
    {  1.749f,  1.5f, 0b0'0'01'1 },
    {  1.750f,  2.0f, 0b0'0'10'0 },
    {  1.751f,  2.0f, 0b0'0'10'0 },
    {  1.999f,  2.0f, 0b0'0'10'0 },
    {  2.000f,  2.0f, 0b0'0'10'0 },
    {  2.001f,  2.0f, 0b0'0'10'0 },
    {  2.499f,  2.0f, 0b0'0'10'0 },
    {  2.500f,  3.0f, 0b0'0'10'1 },
    {  2.501f,  3.0f, 0b0'0'10'1 },
    {  2.999f,  3.0f, 0b0'0'10'1 },
    {  3.000f,  3.0f, 0b0'0'10'1 },
    {  3.001f,  3.0f, 0b0'0'10'1 },
    {  4.000f,  4.0f, 0b0'0'11'0 },
    {  4.999f,  4.0f, 0b0'0'11'0 },
    {  5.000f,  6.0f, 0b0'0'11'1 },
    {  5.001f,  6.0f, 0b0'0'11'1 },
    {  5.999f,  6.0f, 0b0'0'11'1 },
    {  6.000f,  6.0f, 0b0'0'11'1 },
    {  7.000f,  6.0f, 0b0'0'11'1 },
    {  8.000f,  6.0f, 0b0'0'11'1 },
    { 64.000f,  6.0f, 0b0'0'11'1 },
    {     INF,  6.0f, 0b0'0'11'1 },

};

static tc_s e4m3_tests[] =  {
    { -1.0f,   -1.0f, 0b1'0111'000 },
    {  1.0f,    1.0f, 0b0'0111'000 },
};

int main() {
    TEST(cmxe2m1, e2m1_tests);
    TEST(cmxe4m3, e4m3_tests);
}

#if 0
    {  0x1.3fp0, 0x1.00p0, 0b0'0'01'0 }, // 1.25 - eps
    {  0x1.40p0, 0x1.80p0, 0b0'0'01'1 }, // 1.25
    {  0x1.41p0, 0x1.80p0, 0b0'0'01'1 }, // 1.25 + eps
    {  0x1.7fp0, 0x1.80p0, 0b0'0'01'1 }, // 1.5 - eps
    {  0x1.80p0, 0x1.80p0, 0b0'0'01'1 }, // 1.5
    {  0x1.81p0, 0x1.80p0, 0b0'0'01'1 }, // 1.5 + eps
    {  0x1.ffp0, 0x2.00p0, 0b0'0'10'0 }, // 2 - eps
    {  0x2.00p0, 0x2.00p0, 0b0'0'10'0 }, // 2
    {  0x2.01p0, 0x2.00p0, 0b0'0'10'0 }, // 2 + eps
    {  0x2.ffp0, 0x3.00p0, 0b0'0'10'1 }, // 3 - eps
    {  0x3.00p0, 0x3.00p0, 0b0'0'10'1 }, // 3
    {  0x3.01p0, 0x3.00p0, 0b0'0'10'1 }, // 3 + eps
    {  0x3.7fp0, 0x3.00p0, 0b0'0'10'1 }, // 3.5 - eps
    {  0x3.80p0, 0x4.00p0, 0b0'0'11'0 }, // 3.5
    {  0x3.81p0, 0x4.00p0, 0b0'0'11'0 }, // 3.5 + eps
#endif
